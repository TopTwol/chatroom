<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LAN P2P Chat</title>
<style>
  body{font-family:sans-serif;background:#0f1724;color:#e6eef8;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px;height:100vh;margin:0;}
  h1{margin-bottom:6px;}
  .chat{display:flex;flex-direction:column;gap:10px;width:100%;max-width:500px;}
  .messages{flex:1;overflow:auto;background:#0b1220;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);height:400px;}
  .msg{margin-bottom:6px;}
  .msg.me{text-align:right;color:#34d399;}
  .msg.peer{text-align:left;color:#60a5fa;}
  input, button{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.05);background:#0b1220;color:#e6eef8;font-size:14px;}
  .inputrow{display:flex;gap:8px;}
  .controls{margin-bottom:12px;display:flex;flex-direction:column;gap:8px;}
  textarea{width:100%;height:120px;background:#0b1220;color:#e6eef8;border-radius:6px;padding:8px;font-family:monospace;}
</style>
</head>
<body>
<h1>LAN P2P Chat</h1>
<p>Host: click "Create Connection". Connect: enter host's Local SDP below.</p>

<div class="controls">
  <button id="createConn">Create Connection (Host)</button>
  <button id="connectTo">Connect to Host</button>
  <textarea id="hostSDP" placeholder="Host SDP / paste here if connecting"></textarea>
</div>

<div class="chat">
  <div class="messages" id="messages"></div>
  <div class="inputrow">
    <input id="msgInput" placeholder="Type message..." disabled>
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<script>
let pc, dc;
const messages=document.getElementById('messages');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const hostSDP=document.getElementById('hostSDP');

function appendMessage(txt,type='peer'){const d=document.createElement('div');d.className='msg '+(type==='me'?'me':'peer');d.textContent=txt;messages.appendChild(d);messages.scrollTop=messages.scrollHeight;}

async function createPeerConnection(isOfferer){
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  if(isOfferer){
    dc=pc.createDataChannel('chat');
    wireDataChannel(dc,true);
  }else{
    pc.ondatachannel=e=>wireDataChannel(e.channel,false);
  }
  pc.oniceconnectionstatechange=()=>console.log('ICE',pc.iceConnectionState);
  return pc;
}

function wireDataChannel(channel,createdByLocal){
  dc=channel;
  dc.onopen=()=>{msgInput.disabled=false;sendBtn.disabled=false;appendMessage(createdByLocal?'[you opened channel]':'[peer opened channel]','peer');};
  dc.onmessage=e=>appendMessage(e.data,'peer');
  dc.onclose=()=>{appendMessage('[datachannel closed]','peer');msgInput.disabled=true;sendBtn.disabled=true;};
}

async function createConnection(){
  await createPeerConnection(true);
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await new Promise(res=>{
    const interval=setInterval(()=>{if(pc.iceGatheringState==='complete'){clearInterval(interval);res();}},100);
    setTimeout(res,3000);
  });
  hostSDP.value=JSON.stringify(pc.localDescription);
  alert('Copy this SDP and give to the connecting device');
}

async function connectToHost(){
  const sdp=hostSDP.value.trim();
  if(!sdp)return alert('Paste host SDP first');
  await createPeerConnection(false);
  await pc.setRemoteDescription(JSON.parse(sdp));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await new Promise(res=>{
    const interval=setInterval(()=>{if(pc.iceGatheringState==='complete'){clearInterval(interval);res();}},100);
    setTimeout(res,3000);
  });
  hostSDP.value=JSON.stringify(pc.localDescription);
  alert('Send this answer back to host and paste it there in the same box');
}

createConn.onclick=createConnection;
connectTo.onclick=connectToHost;

sendBtn.onclick=()=>{
  const v=msgInput.value.trim();if(!v||!dc||dc.readyState!=='open')return;
  dc.send(v);appendMessage(v,'me');msgInput.value='';
};
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}});
</script>
</body>
</html>
